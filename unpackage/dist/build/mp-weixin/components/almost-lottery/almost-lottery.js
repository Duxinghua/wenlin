(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["components/almost-lottery/almost-lottery"],{3785:function(t,e,i){"use strict";i.r(e);var n=i("6154"),a=i("e120");for(var r in a)"default"!==r&&function(t){i.d(e,t,(function(){return a[t]}))}(r);i("7f67");var s,o=i("f0c5"),u=Object(o["a"])(a["default"],n["b"],n["c"],!1,null,"3fff32bb",null,!1,n["a"],s);e["default"]=u.exports},"59f3":function(t,e,i){},6154:function(t,e,i){"use strict";var n;i.d(e,"b",(function(){return a})),i.d(e,"c",(function(){return r})),i.d(e,"a",(function(){return n}));var a=function(){var t=this,e=t.$createElement;t._self._c},r=[]},"7f67":function(t,e,i){"use strict";var n=i("59f3"),a=i.n(n);a.a},d8c9:function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=r(i("a34a")),a=(i("249b"),i("33d2"));function r(t){return t&&t.__esModule?t:{default:t}}function s(t,e,i,n,a,r,s){try{var o=t[r](s),u=o.value}catch(c){return void i(c)}o.done?e(u):Promise.resolve(u).then(n,a)}function o(t){return function(){var e=this,i=arguments;return new Promise((function(n,a){var r=t.apply(e,i);function o(t){s(r,n,a,o,u,"next",t)}function u(t){s(r,n,a,o,u,"throw",t)}o(void 0)}))}}var u={name:"AlmostLottery",props:{canvasWidth:{type:Number,default:240},canvasHeight:{type:Number,default:240},prizeList:{type:Array,required:!0,validator:function(t){return t.length>1}},prizeIndex:{type:Number,required:!0},colors:{type:Array,default:function(){return["#FFFFFF","#FFE9AA"]}},duration:{type:Number,default:8},ringCount:{type:Number,default:8},pointerPosition:{type:String,default:"edge",validator:function(t){return"edge"===t||"middle"===t}},fontColor:{type:String,default:"#C30B29"},fontSize:{type:Number,default:12},lineHeight:{type:Number,default:16},strKey:{type:String,default:"name"},strMaxLen:{type:Number,default:12},strLineLen:{type:Number,default:6},imageWidth:{type:Number,default:30},imageHeight:{type:Number,default:30},successMsg:{type:String,default:"奖品准备就绪，快来参与抽奖吧"},failMsg:{type:String,default:"奖品仍在准备中，请稍后再来..."},canvasCached:{type:Boolean,default:!0},canvasMargin:{type:Number,default:5}},data:function(){return{className:"almost-lottery__canvas",canvasId:"almostLotteryCanvas",lotteryImg:"",targetAngle:0,transitionDuration:0,isRotate:!1,stayIndex:0,targetIndex:0,isCacheImg:!1,oldLotteryImg:"",measureText:""}},computed:{canvasAngle:function(){var t=this.prizeList.length,e=360/t,i=0,n=90/e;return i="edge"===this.pointerPosition?-e*n:-(e*n+e/2),i},outsideRadius:function(){return this.canvasWidth/2},insideRadius:function(){return 20},textRadius:function(){return this.fontSize/2},textDistance:function(){var t=Math.round(this.outsideRadius-this.insideRadius/2);return t-this.textRadius},pixelRatio:function(){return t.getSystemInfoSync().pixelRatio},canvasMarginTotal:function(){var t=5,e=2*this.canvasMargin;return this.canvasWidth>240?-this.canvasWidth/240*2-e:this.canvasWidth<240?t+this.canvasWidth/240*2-e:t-e},actionSize:function(){return this.canvasWidth/2.4}},watch:{prizeIndex:function(t,e){t>-1?(this.targetIndex=t,this.onRotateStart()):console.info("旋转结束，prizeIndex 已重置")}},methods:{onRotateStart:function(){var t=this;if(!this.isRotate){this.isRotate=!0;var e=this.prizeList.length,i=360/e,n=0;n=0===this.targetAngle?270-(this.targetIndex-this.stayIndex)*i-i/2-this.canvasAngle:-(this.targetIndex-this.stayIndex)*i,this.stayIndex=this.targetIndex,this.targetAngle+=n+360*this.ringCount;var a=1e3*this.transitionDuration+100,r=setTimeout((function(){clearTimeout(r),r=null,t.isRotate=!1,t.$emit("draw-end")}),a),s=setTimeout((function(){clearTimeout(s),s=null,t.$emit("reset-index")}),a+50)}},handleActionStart:function(){this.isRotate||this.$emit("draw-start")},onCreateCanvas:function(){var e=this;return o(n.default.mark((function i(){var r,s,o,u,c,l,d,h,f,g,m,v,x,p,y,I,b,k,z,S,L,T,C;return n.default.wrap((function(i){while(1)switch(i.prev=i.next){case 0:r=e.canvasId,s=t.createCanvasContext(r,e),o=e.canvasWidth,u=e.canvasHeight,c=e.prizeList.length,l=2*Math.PI/c,s.setStrokeStyle("#FFBE04"),s.setFontSize(e.fontSize),d=0;case 9:if(!(d<c)){i.next=77;break}if(h=e.prizeList[d],f=d*l,s.save(),s.beginPath(),s.arc(.5*o,.5*u,e.outsideRadius,f,f+l,!1),s.arc(.5*o,.5*u,e.insideRadius,f+l,f,!0),s.stroke(),2===e.colors.length?s.setFillStyle(e.colors[d%2]):s.setFillStyle(e.colors[d]),s.fill(),g=.5*o+Math.cos(f+l/2)*e.textDistance,m=.5*u+Math.sin(f+l/2)*e.textDistance,s.translate(g,m),s.setFillStyle(e.fontColor),v=e.strLimit(h[e.strKey]),s.rotate(f+l/2+Math.PI/2),x=v.length>e.strLineLen,p=12===e.fontSize?0:e.textRadius,!x){i.next=49;break}v=v.substring(0,e.strLineLen)+","+v.substring(e.strLineLen),y=v.split(","),I=0;case 31:if(!(I<y.length)){i.next=47;break}if(!s.measureText||!s.measureText(y[I]).width){i.next=37;break}b=s.measureText(y[I]),s.fillText(y[I],-(b.width/2+p),I*e.lineHeight),i.next=44;break;case 37:return e.measureText=y[I],i.next=40,e.$nextTick();case 40:return i.next=42,e.getTextWidth();case 42:k=i.sent,s.fillText(y[I],-(k/2+p),I*e.lineHeight);case 44:I++,i.next=31;break;case 47:i.next=61;break;case 49:if(!s.measureText||!s.measureText(v).width){i.next=54;break}z=s.measureText(v),s.fillText(v,-(z.width/2+p),0),i.next=61;break;case 54:return e.measureText=v,i.next=57,e.$nextTick();case 57:return i.next=59,e.getTextWidth();case 59:S=i.sent,s.fillText(v,-(S/2+p),0);case 61:if(!h.prizeImage){i.next=73;break}if(L=/^(https|http)/g,!L.test(h.prizeImage)){i.next=72;break}return console.warn("###当前数据列表中的奖品图片为网络图片，开始下载图片...###"),i.next=67,(0,a.downloadFile)(h.prizeImage);case 67:T=i.sent,console.log("处理远程图片",T),T.ok&&(C=T.tempFilePath,h.prizeImage=C),i.next=72;break;case 72:s.drawImage(h.prizeImage,-e.imageWidth/2,o/10,e.imageWidth,e.imageHeight);case 73:s.restore();case 74:d++,i.next=9;break;case 77:s.draw(!0,(function(){var i=setTimeout((function(){clearTimeout(i),i=null,t.canvasToTempFilePath({destWidth:e.canvasWidth*e.pixelRatio,destHeight:e.canvasHeight*e.pixelRatio,canvasId:e.canvasId,success:function(t){e.handlePrizeImg({ok:!0,data:t.tempFilePath,msg:"画布导出生成图片成功"})},fail:function(t){e.handlePrizeImg({ok:!1,data:t,msg:"画布导出生成图片失败"})}},e)}),500)}));case 78:case"end":return i.stop()}}),i)})))()},handlePrizeImg:function(e){var i=this;if(e.ok){var n=e.data;if(!this.canvasCached)return this.lotteryImg=n,void this.handlePrizeImgSuc(e);this.isCacheImg?t.getSavedFileList({success:function(t){for(var a=t.fileList,r=!1,s=0;s<a.length;s++){var o=a[s];if(o.filePath===n){r=!0,i.lotteryImg=n,console.info("经查，本地缓存中存在转盘图可用，本次将不再绘制转盘"),i.handlePrizeImgSuc(e);break}}r||(console.info("经查，本地缓存中存在转盘图不可用，需要重新初始化转盘绘制"),i.initCanvasDraw())},fail:function(t){i.initCanvasDraw()}}):t.saveFile({tempFilePath:n,success:function(t){var e=t.savedFilePath;(0,a.setStore)("lotteryImg",e),i.lotteryImg=e,i.handlePrizeImgSuc({ok:!0,data:e,msg:"画布导出生成图片成功"})},fail:function(t){i.handlePrizeImg({ok:!1,data:t,msg:"画布导出生成图片失败"})}})}else console.error("处理导出的图片失败",e),t.hideLoading(),console.error("###当前为小程序端，下载网络图片需要配置域名白名单###")},handlePrizeImgSuc:function(e){t.hideLoading(),this.$emit("finish",{ok:e.ok,data:e.data,msg:e.ok?this.successMsg:this.failMsg})},getTextWidth:function(){var e=this;return new Promise((function(i,n){t.createSelectorQuery().in(e).select(".almost-lottery__measureText").fields({size:!0},(function(t){i(t.width)})).exec()}))},strLimit:function(t){var e=this.strMaxLen;return t&&e&&t.length>e?t.slice(0,e-1)+"...":t},checkCacheImg:function(){console.log("检查本地缓存中是否存在转盘图"),this.oldLotteryImg=(0,a.getStore)("lotteryImg");var t=(0,a.getStore)("prizeList"),e=JSON.stringify(this.prizeList);if(this.oldLotteryImg&&t===e)return console.log("经查，本地缓存中存在转盘图 => ".concat(this.oldLotteryImg)),this.isCacheImg=!0,console.log("需要继续判断这张缓存图是否可用"),void this.handlePrizeImg({ok:!0,data:this.oldLotteryImg,msg:"画布导出生成图片成功"});console.log("经查，本地缓存中不存在转盘图"),this.initCanvasDraw()},initCanvasDraw:function(){console.log("开始初始化转盘绘制"),this.isCacheImg=!1,this.lotteryImg="",(0,a.clearStore)("lotteryImg"),(0,a.setStore)("prizeList",this.prizeList),this.onCreateCanvas()}},mounted:function(){var t=this;this.$nextTick((function(){var e=setTimeout((function(){clearTimeout(e),e=null,t.canvasCached?t.checkCacheImg():t.onCreateCanvas(),t.transitionDuration=t.duration}),50)}))}};e.default=u}).call(this,i("543d")["default"])},e120:function(t,e,i){"use strict";i.r(e);var n=i("d8c9"),a=i.n(n);for(var r in n)"default"!==r&&function(t){i.d(e,t,(function(){return n[t]}))}(r);e["default"]=a.a}}]);
;(global["webpackJsonp"] = global["webpackJsonp"] || []).push([
    'components/almost-lottery/almost-lottery-create-component',
    {
        'components/almost-lottery/almost-lottery-create-component':(function(module, exports, __webpack_require__){
            __webpack_require__('543d')['createComponent'](__webpack_require__("3785"))
        })
    },
    [['components/almost-lottery/almost-lottery-create-component']]
]);
